/**
 * NOVIUS OS - Web OS for digital communication
 *
 * @copyright  2011 Novius
 * @license    GNU Affero General Public License v3 or (at your option) any later version
 *             http://www.gnu.org/licenses/agpl-3.0.html
 * @link http://www.novius-os.org
 */
define("jquery-nos-link-wysiwyg",["jquery-nos","wijmo.wijtabs"],function(a){a.fn.extend({nosLinkWysiwyg:function(b){b=b||{newlink:true,base_url:"",texts:{titleAppdeskPage:"Pick a new link",titleAppdeskMedia:"Pick a new media",titleProperties2:"Edit properties",titleProperties3:"Edit properties"}};return this.each(function(){var t=a(this).find("a[data-id=close]").click(function(B){B.preventDefault();t.nosDialog("close")}).end(),p=t.attr("id"),r,u,y=t.find(":radio[name=link_type]").click(function(){var B=a(this).val();if(B!==r){x.val("")}r=B;s(r,true)}),z=t.find("#"+p+"_properties").find("> form").nosFormValidate({submitHandler:function(){var B={href:x.val()+(r==="internal"?f.val():""),title:d.val()};if(a.inArray("target",o[r])!==-1){B.target=z.find(":radio[name=target]:checked").val()}A.trigger("insert.link",B)}}).end(),x=t.find("#"+p+"_url"),f=t.find("#"+p+"_url_params"),d=t.find("#"+p+"_tooltip"),c=t.find("#"+p+"_anchor").change(function(){var B=a(this).find("option:selected").val();x.val(B?B:"")}),v=t.find("#"+p+"_email").change(function(){var B=a(this).val();x.val(B?"mailto:"+B:"")}),j=t.find("#"+p+"_phone").change(function(){var B=a(this).val();x.val(B?"tel:"+B:"")}),n=t.find("#"+p+"_url_real"),k=t.find("> ul").css({width:"18%"}),h=k.find("li:last a"),A=t.closest(".ui-dialog-content").bind("select_media",function(C,B){n.text(b.base_url+B.path);x.val("nos://media/"+B.id);t.wijtabs("enableTab",2).wijtabs("select",2)}).bind("select_page",function(C,B){n.text(B.url);x.val("nos://page/"+B.id);t.wijtabs("enableTab",2).wijtabs("select",2)}),s=function(C,B){switch(C){case"internal":case"media":var D=C==="internal"?b.texts.titleAppdeskPage:b.texts.titleAppdeskMedia;if(k.find("li").size()===2){t.wijtabs("add","#"+p+"_appdesk",D,1);h.text(b.texts.titleProperties3)}else{k.find("li:eq(1) a").text(D)}break;case"external":case"anchor":case"email":case"phone":if(k.find("li").size()>2){t.wijtabs("remove",1);u=null;h.text(b.texts.titleProperties2)}t.wijtabs("enableTab",1);break}if(B){t.wijtabs("select",1)}},i=["url","anchor","email","phone","url_params","tooltip","target"],o={internal:["url","url_params","tooltip","target"],external:["url","tooltip","target"],media:["url","tooltip","target"],anchor:["anchor","tooltip"],email:["email","tooltip"],phone:["phone","tooltip"]},g=A.data("tinymce"),q=g.dom.getParent(g.selection.getNode(),"A"),m=g.dom.select("a.mceItemAnchor,img.mceItemAnchor");a.each(m,function(D,C){var B=g.dom.getAttrib(C,"name");if(B){a("<option></option>").val("#"+B).text(B).appendTo(c)}});a.each(i,function(B,C){z.find("#tr_"+p+"_"+C).hide()});if(q){var e=a(q),w=e.attr("href"),l;x.val(w);d.val(e.attr("title"));z.find(":radio[name=target]").eq(e.attr("target")?0:1).prop("checked",true);if(w.substr(0,11)==="nos://page/"){l=w.match(/nos:\/\/page\/(\d+)(.*)/i);if(l){r="internal";a.ajax({method:"GET",url:b.base_url+"admin/noviusos_page/appdesk/info/"+l[1],dataType:"json",success:function(B){n.text(b.base_url+B.url)}});f.val(l[2])}}else{if(w.substr(0,12)==="nos://media/"){l=w.match(/nos:\/\/media\/(\d+)/i);if(l){r="media";a.ajax({method:"GET",url:b.base_url+"admin/noviusos_media/appdesk/info/"+l[1],dataType:"json",success:function(B){n.text(b.base_url+B.path)}})}}else{if(w.substr(0,1)==="#"){r="anchor";c.find('option[value="'+w+'"]').prop("selected",true)}else{if(w.substr(0,7)==="mailto:"){r="email";v.val(w.replace("mailto:",""))}else{if(w.substr(0,4)==="tel:"){r="phone";j.val(w.replace("tel:",""))}else{r="external"}}}}}y.filter("[value="+r+"]").prop("checked",true)}t.wijtabs({alignment:"left",load:function(D,C){var B=a(C.panel).outerHeight(true)-a(C.panel).innerHeight();a(C.panel).height(A.height()-B)},disabledIndexes:b.newlink?[1]:[],select:function(E,D){var F=a(D.panel);if(F.attr("id")===(p+"_appdesk")){F.addClass("box-sizing-border");if(u!=r){F.empty().show().css({width:"100%",padding:0,margin:0}).load(r==="internal"?"admin/noviusos_page/appdesk/index/link_pick":"admin/noviusos_media/appdesk/index/media_pick");u=r}}else{if(D.panel===z[0]){var C=o[r],B=z.find(":radio[name=target]:checked");c.add(v).add(j).removeClass("required");t.find("#"+p+"_"+C[0]).addClass("required");a.each(i,function(G,H){z.find("#tr_"+p+"_"+H)[a.inArray(H,C)===-1?"hide":"show"]()});if(!B.size()){z.find(":radio[name=target]").eq(r==="internal"?1:0).prop("checked",true)}if(a.inArray(r,["media","internal"])!==-1){n.show();x.hide()}else{n.hide();x.show()}}}},show:function(C,B){a(B.panel).nosOnShow()}}).find(".wijmo-wijtabs-content").css("width","81%").addClass("box-sizing-border").end().nosFormUI();if(q){s(r);t.wijtabs("select",k.find("li").size()-1)}})}});return a});