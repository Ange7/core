/**
 * NOVIUS OS - Web OS for digital communication
 *
 * @copyright  2011 Novius
 * @license    GNU Affero General Public License v3 or (at your option) any later version
 *             http://www.gnu.org/licenses/agpl-3.0.html
 * @link http://www.novius-os.org
 */
define("jquery-nos-appstab",["jquery-nos","jquery-ui.sortable"],function(a){a.fn.extend({nosAppsTab:function(b){b=b||{backgroundUrl:null};return this.each(function(){var k=a(this).nosListenEvent({name:"Nos\\Application"},function(l){a.ajax({url:"admin/nos/noviusos/appstab",success:function(m){k.parent().empty().append(m)}})}),i=function(n){n.preventDefault();var m=a(this),l=m.data("launcher");if(l.action.tab){l.action.tab=a.extend({app:true,iconSize:32,labelDisplay:false},l.action.tab)}m.nosAction(l.action)},c=150,g=0,d={},h=[],e={},j=k.find(".app").each(function(){var l=a(this).outerHeight(true);if(a(this).outerHeight(true)>g){g=l}}),f=function(){var l={};j.each(function(){var n=a(this),m=n.data("launcher");l[m.key]={position:m.position}});j.nosSaveUserConfig("misc.apps",l)};j.each(function(){var m=a(this),l=m.data("launcher");if(l.position&&(l.position.left*c+c)<k.width()){m.css({left:(l.position.left*c)+"px",top:(l.position.top*g)+"px",visibility:"visible"});d[l.position.left]=d[l.position.left]||{};d[l.position.left][l.position.top]=true}else{h.push(m)}});if(h.length){a.each(h,function(){var o=this,l=o.data("launcher"),n=0,m=0;while(1==1){if(d[n]&&d[n][m]){n++;if((n*c+c)>k.width()){n=0;m++}continue}else{l.position={left:n,top:m};o.css({left:(n*c)+"px",top:(m*g)+"px",visibility:"visible"});d[n]=d[n]||{};d[n][m]=true;e[o.data("launcher").key]={position:{left:n,top:m}};break}}});f()}j.draggable({containement:k,grid:[c,g],scroll:false,stop:function(q,n){var l=a(this),r=n.position,m=l.data("launcher"),p=parseInt(r.left/c),o=parseInt(r.top/g);l.unbind("click");l.one("click",function(s){s.preventDefault();s.stopImmediatePropagation();a(this).click(function(t){i.call(this,t)})});if((r.left+c)>k.width()||(d[p]&&d[p][o])){l.animate({left:(m.position.left*c)+"px",top:(m.position.top*g)+"px"},200)}else{d[m.position.left]=d[m.position.left]||{};d[m.position.left][m.position.top]=false;m.position={left:p,top:o};d[p]=d[p]||{};d[p][o]=true;f()}}});k.find("a.app").click(function(l){i.call(this,l)})})}});return a});