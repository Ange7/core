/**
 * NOVIUS OS - Web OS for digital communication
 *
 * @copyright  2011 Novius
 * @license    GNU Affero General Public License v3 or (at your option) any later version
 *             http://www.gnu.org/licenses/agpl-3.0.html
 * @link http://www.novius-os.org
 */
define("jquery-nos-image-wysiwyg",["jquery-nos","wijmo.wijtabs"],function(a){"use strict";return a.fn.extend({nosImageWysiwyg:function(t){return t=t||{newImg:!0,appdeskView:"",base_url:"",texts:{imageFirst:"Please choose an image first"}},this.each(function(){var e=a(this).find("> form").submit(function(a){e.find("button[data-id=save]").triggerHandler("click"),a.stopPropagation(),a.preventDefault()}).end().find("a[data-id=close]").click(function(a){a.preventDefault(),e.nosDialog("close")}).end().find("button[data-id=save]").click(function(e){var n=a("<img />");return b&&b._id?(n.attr("height",r.val()),n.attr("width",d.val()),n.attr("title",l.val()),n.attr("alt",c.val()),n.attr("style",v.val()),n.attr("class",m.val()),n.attr("data-media",JSON.stringify(b)),n.attr("src",b.path),i.trigger("insert.media",n),e.stopPropagation(),void e.preventDefault()):void a.nosNotify(t.texts.imageFirst,"error")}).end().find("> ul").css({width:"18%"}).end(),i=e.closest(".ui-dialog-content").bind("select_media",function(a,t){k(t)}).nosListenEvent({name:"Nos\\Media\\Model_Media",action:"insert"},function(e){a.ajax({method:"GET",url:t.base_url+"admin/noviusos_media/appdesk/info/"+e.id,dataType:"json",success:function(a){k(a)}})}),n=e.find("div:eq(0)").css({width:"100%",padding:0,margin:0}),s=e.find("img").hide().parent().css("vertical-align","top").end(),r=e.find("input[data-id=height]"),d=e.find("input[data-id=width]").bind("change keyup",function(){if(f.is(":checked")&&b&&b.width&&b.height){var a=d.val();r.val(""==a?"":Math.round(a*b.height/b.width))}}),l=e.find("input[data-id=title]").bind("change keyup",function(){p.is(":checked")&&c.val(l.val())}),c=e.find("input[data-id=alt]"),o=e.find("select[data-id=align]").change(function(){w()}),g=e.find("input[data-id=border]").change(function(){w()}),h=e.find("input[data-id=vspace]").change(function(){w()}),u=e.find("input[data-id=hspace]").change(function(){w()}),v=e.find("input[data-id=style]").change(function(){var t=a('<img style="'+v.val()+'" />');o.val(y(t,"align")),g.val(y(t,"border")),h.val(y(t,"vspace")),u.val(y(t,"hspace"))}),f=e.find("input[data-id=proportional]").change(function(){f.is(":checked")?(r.attr("readonly",!0).addClass("ui-state-disabled"),d.triggerHandler("change")):r.removeAttr("readonly").removeClass("ui-state-disabled")}),p=e.find("input[data-id=same_title_alt]").change(function(){p.is(":checked")?c.attr("readonly",!0).addClass("ui-state-disabled"):c.removeAttr("readonly").removeClass("ui-state-disabled"),l.triggerHandler("change")}),m=e.find("input[data-id=class]"),b=null,w=function(){var t,e=a('<img style="'+v.val()+'" />');t=o.val(),t?"left"==t||"right"==t?(e.css("float",t),e.css("vertical-align","")):(e.css("vertical-align",t),e.css("float","")):(e.css("float",""),e.css("vertical-align","")),t=g.val(),t&&"0"!==t?(e.css("border-width",t+"px"),e.css("border")||e.css("border-color")||e.css("border-style")||e.css("border",t+"px solid black")):e.css("border",""),e.css("margin",""),t=u.val(),t&&"0"!==t&&(e.css("margin-left",t+"px"),e.css("margin-right",t+"px")),t=h.val(),t&&"0"!==t&&(e.css("margin-top",t+"px"),e.css("margin-bottom",t+"px")),v.val(e.attr("style"))},y=function(t,e){var i,n;switch(e){case"align":if(i=a(t).css("float"),i&&"none"!=i)return i;if(i=a(t).css("vertical-align"))return i;break;case"hspace":if(i=a(t).css("margin-left"),n=a(t).css("margin-right"),i&&i==n)return i=parseInt(i.replace(/[^0-9]/g,"")),i||"";break;case"vspace":if(i=a(t).css("margin-top"),n=a(t).css("margin-bottom"),i&&i==n)return i=parseInt(i.replace(/[^0-9]/g,"")),i||"";break;case"border":if(i=0,a.each(["top","right","bottom","left"],function(e,n){return n=a(t).css("border-"+n+"-width"),!n||n!=i&&0!==i?(i=0,!1):void(n&&(i=n))}),i)return i=parseInt(i.replace(/[^0-9]/g,"")),i||""}return""},k=function(a,t){return b=a,b&&b.thumbnail&&s.attr("src",b.thumbnail.replace(/64/g,"128")).show(),null==t?(r.val(a.height),d.val(a.width),l.val(a.title),c.val(a.title),o.val(""),g.val(""),h.val(""),u.val(""),v.val(""),m.val(""),void e.wijtabs("enableTab",1).wijtabs("select",1)):(r.val(t.attr("height")),d.val(t.attr("width")),l.val(t.attr("title")),c.val(t.attr("alt")),o.val(y(t,"align")),g.val(y(t,"border")),h.val(y(t,"vspace")),u.val(y(t,"hspace")),v.val(t.attr("style")),m.val(t.attr("class")),w(),b&&Math.round(d.val()*b.height/b.width)!=r.val()&&f.prop("checked",!1).change(),void(l.val()!=c.val()&&p.prop("checked",!1).change()))},j=i.data("tinymce"),x=j.selection.getNode();if("IMG"==x.nodeName){var I=a(x),_=I.data("media-id");_?a.ajax({method:"GET",url:t.base_url+"admin/noviusos_media/appdesk/info/"+_,dataType:"json",success:function(a){k(a,I)}}):k(I.data("media"),I)}e.wijtabs({alignment:"left",load:function(t,e){var n=a(e.panel).outerHeight(!0)-a(e.panel).innerHeight();a(e.panel).height(i.height()-n)},disabledIndexes:t.newImg?[1]:[],show:function(t,e){a(e.panel).nosOnShow()}}).find(".wijmo-wijtabs-content").css({width:"81%",position:"relative"}).addClass("box-sizing-border").end().nosFormUI(),f.triggerHandler("change"),p.triggerHandler("change"),t.newImg?n.html(t.appdeskView):e.wijtabs("select",1).bind("wijtabsshow",function(){n.html(t.appdeskView)})})}}),a});