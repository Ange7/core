/**
 * NOVIUS OS - Web OS for digital communication
 *
 * @copyright  2011 Novius
 * @license    GNU Affero General Public License v3 or (at your option) any later version
 *             http://www.gnu.org/licenses/agpl-3.0.html
 * @link http://www.novius-os.org
 */
define("jquery-nos-image-wysiwyg",["jquery-nos","wijmo.wijtabs"],function(a){a.fn.extend({nosImageWysiwyg:function(b){b=b||{newImg:true,appdeskView:"",base_url:"",texts:{imageFirst:"Please choose an image first"}};return this.each(function(){var t=a(this).find("> form").submit(function(B){t.find("button[data-id=save]").triggerHandler("click");B.stopPropagation();B.preventDefault()}).end().find("a[data-id=close]").click(function(B){B.preventDefault();t.nosDialog("close")}).end().find("button[data-id=save]").click(function(C){var B=a("<img />");if(!i||!i._id){a.nosNotify(b.texts.imageFirst,"error");return}B.attr("height",v.val());B.attr("width",h.val());B.attr("title",r.val());B.attr("alt",k.val());B.attr("style",n.val());B.attr("class",d.val());B.attr("data-media",JSON.stringify(i));B.attr("src",i.path);z.trigger("insert.media",B);C.stopPropagation();C.preventDefault()}).end().find("> ul").css({width:"18%"}).end(),z=t.closest(".ui-dialog-content").bind("select_media",function(C,B){y(B)}).nosListenEvent({name:"Nos\\Media\\Model_Media",action:"insert"},function(B){a.ajax({method:"GET",url:b.base_url+"admin/noviusos_media/appdesk/info/"+B.id,dataType:"json",success:function(e){y(e)}})}),f=t.find("div:eq(0)").css({width:"100%",padding:0,margin:0}),o=t.find("img").hide().parent().css("vertical-align","top").end(),v=t.find("input[data-id=height]"),h=t.find("input[data-id=width]").bind("change keyup",function(){if(p.is(":checked")&&i&&i.width&&i.height){var e=h.val();v.val(e==""?"":Math.round(e*i.height/i.width))}}),r=t.find("input[data-id=title]").bind("change keyup",function(){if(A.is(":checked")){k.val(r.val())}}),k=t.find("input[data-id=alt]"),l=t.find("select[data-id=align]").change(function(){s()}),x=t.find("input[data-id=border]").change(function(){s()}),q=t.find("input[data-id=vspace]").change(function(){s()}),u=t.find("input[data-id=hspace]").change(function(){s()}),n=t.find("input[data-id=style]").change(function(){var e=a('<img style="'+n.val()+'" />');l.val(j(e,"align"));x.val(j(e,"border"));q.val(j(e,"vspace"));u.val(j(e,"hspace"))}),p=t.find("input[data-id=proportional]").change(function(){if(p.is(":checked")){v.attr("readonly",true).addClass("ui-state-disabled");h.triggerHandler("change")}else{v.removeAttr("readonly").removeClass("ui-state-disabled")}}),A=t.find("input[data-id=same_title_alt]").change(function(){if(A.is(":checked")){k.attr("readonly",true).addClass("ui-state-disabled")}else{k.removeAttr("readonly").removeClass("ui-state-disabled")}r.triggerHandler("change")}),d=t.find("input[data-id=class]"),i=null,s=function(){var e,B=a('<img style="'+n.val()+'" />');e=l.val();if(e){if(e=="left"||e=="right"){B.css("float",e);B.css("vertical-align","")}else{B.css("vertical-align",e);B.css("float","")}}else{B.css("float","");B.css("vertical-align","")}e=x.val();if(e&&e!=="0"){B.css("border-width",e+"px");if(!B.css("border")&&!B.css("border-color")&&!B.css("border-style")){B.css("border",e+"px solid black")}}else{B.css("border","")}B.css("margin","");e=u.val();if(e&&e!=="0"){B.css("margin-left",e+"px");B.css("margin-right",e+"px")}e=q.val();if(e&&e!=="0"){B.css("margin-top",e+"px");B.css("margin-bottom",e+"px")}n.val(B.attr("style"))},j=function(C,e){var B,D;switch(e){case"align":B=a(C).css("float");if(B&&B!="none"){return B}if(B=a(C).css("vertical-align")){return B}break;case"hspace":B=a(C).css("margin-left");D=a(C).css("margin-right");if(B&&B==D){B=parseInt(B.replace(/[^0-9]/g,""));return B||""}break;case"vspace":B=a(C).css("margin-top");D=a(C).css("margin-bottom");if(B&&B==D){B=parseInt(B.replace(/[^0-9]/g,""));return B||""}break;case"border":B=0;a.each(["top","right","bottom","left"],function(E,F){F=a(C).css("border-"+F+"-width");if(!F||(F!=B&&B!==0)){B=0;return false}if(F){B=F}});if(B){B=parseInt(B.replace(/[^0-9]/g,""));return B||""}break}return""},y=function(B,e){i=B;if(i&&i.thumbnail){o.attr("src",i.thumbnail.replace(/64/g,"128")).show()}if(e==null){v.val(B.height);h.val(B.width);r.val(B.title);k.val(B.title);l.val("");x.val("");q.val("");u.val("");n.val("");d.val("");t.wijtabs("enableTab",1).wijtabs("select",1);return}v.val(e.attr("height"));h.val(e.attr("width"));r.val(e.attr("title"));k.val(e.attr("alt"));l.val(j(e,"align"));x.val(j(e,"border"));q.val(j(e,"vspace"));u.val(j(e,"hspace"));n.val(e.attr("style"));d.val(e.attr("class"));s();if(i&&(Math.round(h.val()*i.height/i.width)!=v.val())){p.prop("checked",false).change()}if(r.val()!=k.val()){A.prop("checked",false).change()}},g=z.data("tinymce"),w=g.selection.getNode();if(w.nodeName=="IMG"){var m=a(w),c=m.data("media-id");if(c){a.ajax({method:"GET",url:b.base_url+"admin/noviusos_media/appdesk/info/"+c,dataType:"json",success:function(e){y(e,m)}})}else{y(m.data("media"),m)}}t.wijtabs({alignment:"left",load:function(D,C){var B=a(C.panel).outerHeight(true)-a(C.panel).innerHeight();a(C.panel).height(z.height()-B)},disabledIndexes:b.newImg?[1]:[],show:function(C,B){a(B.panel).nosOnShow()}}).find(".wijmo-wijtabs-content").css({width:"81%",position:"relative"}).addClass("box-sizing-border").end().nosFormUI();p.triggerHandler("change");A.triggerHandler("change");if(!b.newImg){t.wijtabs("select",1).bind("wijtabsshow",function(){f.html(b.appdeskView)})}else{f.html(b.appdeskView)}})}});return a});